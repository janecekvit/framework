trigger:
- master

pool:
  vmImage: 'windows-latest'

variables:
  buildPlatform: 'x64'
  buildConfiguration: 'Release'
  buildDir: '$(Build.SourcesDirectory)\build'

stages:
- stage: Build
  displayName: 'Build and Test'
  jobs:
  - job: BuildTest
    displayName: 'Build and Test Framework'
    
    steps:
    - checkout: self
      displayName: "Checkout repository"
      
    # Cache CMake build directory for faster builds
    - task: Cache@2
      inputs:
        key: 'cmake-build | $(Agent.OS) | $(buildPlatform) | $(buildConfiguration) | CMakeLists.txt | tests'
        path: '$(buildDir)'
        restoreKeys: |
          cmake-build | $(Agent.OS) | $(buildPlatform) | $(buildConfiguration)
          cmake-build | $(Agent.OS) | $(buildPlatform)
      displayName: "Cache CMake build directory"

    # Create build directory
    - script: |
        mkdir $(buildDir) 2>nul || echo "Build directory exists"
      displayName: "Create Build Directory"

    # Re-configure if cache miss
    - script: |
        if not exist $(buildDir)\CMakeCache.txt (
          echo "CMake cache not found, will reconfigure..."
        ) else (
          echo "CMake cache found, skipping reconfiguration"
        )
      displayName: "Check CMake Cache"
      
    - task: CMake@1
      inputs:
        workingDirectory: '$(buildDir)'
        cmakeArgs: >-
          -G "Visual Studio 17 2022" -A x64
          -DCMAKE_BUILD_TYPE=$(buildConfiguration)
          -DBUILD_TESTING=ON
          -DENABLE_CLANG_TIDY=OFF
          -DENABLE_CPPCHECK=OFF
          -DENABLE_CLANG_FORMAT=ON
          $(Build.SourcesDirectory)

    # Build the framework and tests
    - script: |
        echo "Building framework and tests..."
        cd $(buildDir)
        
        cmake --build . --config $(buildConfiguration) --parallel 4 --target framework_tests
        
        if %ERRORLEVEL% neq 0 (
          echo "Build failed!"
          exit /b %ERRORLEVEL%
        )
        echo "Build completed successfully"
      displayName: "Build Framework and Tests"
    
    # Run tests
    - script: |
        echo "Running tests..."
        cd $(buildDir)
        chcp 65001
        .\bin\framework_tests.exe --gtest_output=xml:GoogleTestResults.xml
        echo "Running tests completed"
      displayName: "Run Tests"
      continueOnError: true
      env:
        LANG: 'en_US.UTF-8'
        LC_ALL: 'en_US.UTF-8'

    # Publish test results
    - task: PublishTestResults@2
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '$(buildDir)/GoogleTestResults.xml'
        testRunTitle: 'Framework Unit Tests'
        mergeTestResults: true
        failTaskOnFailedTests: false
      displayName: "Publish Test Results"
      condition: always()

    # Publish build artifacts
    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: '$(buildDir)/bin'
        artifactName: 'framework-binaries-$(buildConfiguration)'
        publishLocation: 'Container'
      displayName: "Publish Build Artifacts"
      condition: always()

    # Build summary
    - script: |
        echo "=== Build Summary ==="
        echo "Configuration: $(buildConfiguration)"
        echo "Platform: $(buildPlatform)"
        echo "Build Directory: $(buildDir)"
        
        cd $(buildDir)
        echo "=== Available executables ==="
        dir bin\*.exe
        
        echo "=== CMake targets ==="
        cmake --build . --target help | findstr "... "
      displayName: "Build Summary"
      condition: always()

- stage: StaticAnalysis
  displayName: 'Static Analysis'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['System.PullRequest.TargetBranch'], 'refs/heads/master'))
  jobs:
  - job: StaticAnalysis
    displayName: 'Run Static Analysis'
    
    steps:
    - checkout: self
      displayName: "Checkout repository"
      
    # Restore CMake build cache
    - task: Cache@2
      inputs:
        key: 'cmake-build | $(Agent.OS) | $(buildPlatform) | $(buildConfiguration) | CMakeLists.txt | tests'
        path: '$(buildDir)'
      displayName: "Restore CMake build cache"

    # Re-configure if cache miss
    - script: |
        if not exist $(buildDir)\CMakeCache.txt (
          echo "CMake cache not found, will reconfigure..."
        ) else (
          echo "CMake cache found, skipping reconfiguration"
        )
      displayName: "Check CMake Cache"
      
    - task: CMake@1
      inputs:
        workingDirectory: '$(buildDir)'
        cmakeArgs: >-
          -G "Visual Studio 17 2022" -A x64
          -DCMAKE_BUILD_TYPE=$(buildConfiguration)
          -DBUILD_TESTING=ON
          -DENABLE_CLANG_TIDY=OFF
          -DENABLE_CPPCHECK=OFF
          -DENABLE_CLANG_FORMAT=ON
          $(Build.SourcesDirectory)
      displayName: "Ensure CMake Configuration"
      condition: not(exists('$(buildDir)/CMakeCache.txt'))

    # Install LLVM/clang-format
    - script: |
        choco install llvm -y
        refreshenv
        clang-format --version
      displayName: "Install LLVM/clang-format"

    # Run format check
    - script: |
        cd $(buildDir)
        echo "Running format check..."
        cmake --build . --config $(buildConfiguration) --target FORMAT_CHECK
      displayName: "Format Check"
      continueOnError: true

    # Run custom static analysis targets if available
    - script: |
        cd $(buildDir)
        echo "Running static analysis..."
        cmake --build . --config $(buildConfiguration) --target STATIC_ANALYSIS_CHECK
      displayName: "Static Analysis"
      continueOnError: true

    # Publish analysis artifacts
    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: '$(buildDir)'
        artifactName: 'static-analysis-results'
        publishLocation: 'Container'
        parallel: true
      displayName: "Publish Analysis Results"
      condition: always()