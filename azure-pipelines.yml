trigger:
- master

pool:
  vmImage: 'windows-latest'

variables:
  buildPlatform: 'x64'
  buildConfiguration: 'Release'
  buildDir: '$(Build.SourcesDirectory)\build'

stages:
- stage: Build
  displayName: 'Build and Test'
  jobs:
  - job: BuildTest
    displayName: 'Build and Test Framework'
    
    steps:
    - checkout: self
      displayName: "Checkout repository"
      
    # Cache CMake build directory for faster builds
    - task: Cache@2
      inputs:
        key: 'cmake-build | $(Agent.OS) | $(buildPlatform) | $(buildConfiguration) | CMakeLists.txt | tests'
        path: '$(buildDir)'
        restoreKeys: |
          cmake-build | $(Agent.OS) | $(buildPlatform) | $(buildConfiguration)
          cmake-build | $(Agent.OS) | $(buildPlatform)
      displayName: "Cache CMake build directory"

    # Configure with CMake
    - script: |
        echo "Setting up CMake configuration..."
        mkdir $(buildDir) 2>nul || echo "Build directory exists"
        cd $(buildDir)
        
        cmake -G "Visual Studio 17 2022" -A x64 ^
          -DCMAKE_BUILD_TYPE=$(buildConfiguration) ^
          -DBUILD_TESTING=ON ^
          -DENABLE_CLANG_TIDY=OFF ^
          -DENABLE_CPPCHECK=OFF ^
          -DENABLE_CLANG_FORMAT=ON ^
          $(Build.SourcesDirectory)
          
        if %ERRORLEVEL% neq 0 (
          echo "CMake configuration failed!"
          exit /b %ERRORLEVEL%
        )
        echo "CMake configuration completed successfully"
      displayName: "Configure with CMake"

    # Build the framework and tests
    - script: |
        echo "Building framework and tests..."
        cd $(buildDir)
        
        cmake --build . --config $(buildConfiguration) --parallel 4 --target framework_tests
        
        if %ERRORLEVEL% neq 0 (
          echo "Build failed!"
          exit /b %ERRORLEVEL%
        )
        echo "Build completed successfully"
      displayName: "Build Framework and Tests"

    # Set up Windows environment for proper Unicode handling
    - script: |
        echo "Setting up Windows environment for tests..."
        chcp 65001
        set LANG=en_US.UTF-8
        echo "Active code page: %ERRORLEVEL%"
      displayName: "Setup Test Environment"

    # Run tests using CTest with detailed output
    - script: |
        echo "Running tests with CTest..."
        cd $(buildDir)
        
        rem Set UTF-8 code page for proper character handling
        chcp 65001
        
        echo "=== Running CTest with detailed failure output ==="
        ctest --output-on-failure --verbose --build-config $(buildConfiguration) --parallel 1
        
        set CTEST_EXIT_CODE=%ERRORLEVEL%
        echo "CTest completed with exit code: %CTEST_EXIT_CODE%"
        
        if %CTEST_EXIT_CODE% neq 0 (
          echo "=== Re-running failed tests individually for better diagnostics ==="
          ctest --output-on-failure --verbose --build-config $(buildConfiguration) --rerun-failed
        )
        
        exit /b %CTEST_EXIT_CODE%
      displayName: "Run Tests (CTest)"
      continueOnError: true

    # Check executable location for debugging
    - script: |
        echo "=== Checking executable location ==="
        cd $(buildDir)
        dir bin /s
        echo "=== Looking for framework_tests.exe ==="
        where /R . framework_tests.exe
      displayName: "Debug Executable Location"
      condition: always()

    # Run tests directly for XML output (GoogleTest format)
    - script: |
        echo "Running tests directly for XML output..."
        cd $(buildDir)
        
        rem Try the flat structure first (based on CMakeLists.txt config)
        if exist ".\bin\framework_tests.exe" (
          echo "Found executable in flat structure"
          set TEST_EXE=.\bin\framework_tests.exe
        ) else if exist ".\bin\$(buildConfiguration)\framework_tests.exe" (
          echo "Found executable in config-specific directory"
          set TEST_EXE=.\bin\$(buildConfiguration)\framework_tests.exe
        ) else (
          echo "ERROR: framework_tests.exe not found in expected locations"
          dir bin
          exit /b 1
        )
        
        rem Set UTF-8 for proper character handling
        chcp 65001
        
        echo "=== Running all tests for XML output ==="
        %TEST_EXE% --gtest_output=xml:GoogleTestResults.xml
        
        echo "=== Running individual failing tests for debugging ==="
        echo "Testing exception handling..."
        %TEST_EXE% --gtest_filter=test_exception.TestSimpleTextException --gtest_also_run_disabled_tests
        %TEST_EXE% --gtest_filter=test_exception.TestWideTextException --gtest_also_run_disabled_tests
        
        echo "Testing trace functionality..."
        %TEST_EXE% --gtest_filter=test_trace.TestTrace --gtest_also_run_disabled_tests
        
        echo "Direct test execution completed"
      displayName: "Run Tests (XML Output)"
      continueOnError: true

    # Publish test results
    - task: PublishTestResults@2
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '$(buildDir)/GoogleTestResults.xml'
        testRunTitle: 'Framework Unit Tests'
        mergeTestResults: true
        failTaskOnFailedTests: true
      displayName: "Publish Test Results"
      condition: always()

    # Show environment and test files for debugging
    - script: |
        echo "=== Environment Diagnostics ==="
        echo "Code page: %CODEPAGE%"
        chcp
        echo "Working directory: %CD%"
        echo "Temp directory: %TEMP%"
        echo "Path: %PATH%"
        
        cd $(buildDir)
        echo "=== Test Output Files ==="
        dir /s *.xml 2>nul || echo "No XML files found"
        
        if exist GoogleTestResults.xml (
          echo "=== GoogleTest Results Preview ==="
          type GoogleTestResults.xml | findstr /C:"testcase" /C:"failure" /C:"error" /C:"testsuite"
        ) else (
          echo "GoogleTestResults.xml not found"
        )
        
        echo "=== CTest Last Run Files ==="
        dir Testing\Temporary 2>nul || echo "No CTest temporary files"
        if exist Testing\Temporary\LastTest.log (
          echo "=== Last few lines of CTest log ==="
          powershell "Get-Content Testing\Temporary\LastTest.log | Select-Object -Last 50"
        )
      displayName: "Debug Test Output and Environment"
      condition: always()

    # Publish build artifacts
    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: '$(buildDir)/bin'
        artifactName: 'framework-binaries-$(buildConfiguration)'
        publishLocation: 'Container'
      displayName: "Publish Build Artifacts"
      condition: always()

    # Build summary
    - script: |
        echo "=== Build Summary ==="
        echo "Configuration: $(buildConfiguration)"
        echo "Platform: $(buildPlatform)"
        echo "Build Directory: $(buildDir)"
        
        cd $(buildDir)
        echo "=== Available executables ==="
        dir bin\$(buildConfiguration)\*.exe
        
        echo "=== CMake targets ==="
        cmake --build . --target help | findstr "... "
      displayName: "Build Summary"
      condition: always()

- stage: StaticAnalysis
  displayName: 'Static Analysis'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
  jobs:
  - job: StaticAnalysis
    displayName: 'Run Static Analysis'
    
    steps:
    - checkout: self
      displayName: "Checkout repository"
      
    # Restore CMake build cache
    - task: Cache@2
      inputs:
        key: 'cmake-build | $(Agent.OS) | $(buildPlatform) | $(buildConfiguration) | CMakeLists.txt | tests'
        path: '$(buildDir)'
      displayName: "Restore CMake build cache"

    # Re-configure if cache miss
    - script: |
        cd $(buildDir)
        if not exist CMakeCache.txt (
          echo "CMake cache not found, reconfiguring..."
          cmake -G "Visual Studio 17 2022" -A x64 ^
            -DCMAKE_BUILD_TYPE=$(buildConfiguration) ^
            -DBUILD_TESTING=ON ^
            -DENABLE_CLANG_TIDY=OFF ^
            -DENABLE_CPPCHECK=OFF ^
            -DENABLE_CLANG_FORMAT=ON ^
            $(Build.SourcesDirectory)
        )
      displayName: "Ensure CMake Configuration"

    # Run format check
    - script: |
        cd $(buildDir)
        echo "Running format check..."
        cmake --build . --target FORMAT_CHECK
      displayName: "Format Check"
      continueOnError: true

    # Run custom static analysis targets if available
    - script: |
        cd $(buildDir)
        echo "Running static analysis..."
        cmake --build . --target STATIC_ANALYSIS_CHECK
      displayName: "Static Analysis"
      continueOnError: true

    # Publish analysis artifacts
    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: '$(buildDir)'
        artifactName: 'static-analysis-results'
        publishLocation: 'Container'
        parallel: true
      displayName: "Publish Analysis Results"
      condition: always()